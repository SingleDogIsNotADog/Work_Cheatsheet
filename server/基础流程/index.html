<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>基础流程 - Work CheatSheet</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Work CheatSheet</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Home</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">docs <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../shell/">shell</a>
</li>
                            
<li >
    <a href="../../vs/">visual studio</a>
</li>
                            
<li >
    <a href="../../vim/">vim</a>
</li>
                            
<li >
    <a href="../../sublime/">sublime</a>
</li>
                            
<li >
    <a href="../../git/">git</a>
</li>
                            
<li >
    <a href="../../gdb/">gdb</a>
</li>
                            
<li >
    <a href="../../cmake/">cmake</a>
</li>
                            
<li >
    <a href="../../makefile/">makefile</a>
</li>
                            
<li >
    <a href="../../svn/">svn</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">work <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../work/gm/">gm命令</a>
</li>
                            
<li >
    <a href="../../work/path/">path</a>
</li>
                            
<li >
    <a href="../../work/WorkCheatsheet/">WorkCheateSheet</a>
</li>
                            
<li >
    <a href="../../work/qa/">question & anwser</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">server <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">开发环境搭建</a>
</li>
                            
<li >
    <a href="../%E5%8F%91%E7%89%88%E4%B8%8E%E7%83%AD%E6%9B%B4/">发版与热更</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">code snippets</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../code_snippets/def/">def</a>
</li>
            
<li >
    <a href="../code_snippets/config/">config</a>
</li>
            
<li >
    <a href="../code_snippets/msg/">msg</a>
</li>
            
<li >
    <a href="../code_snippets/role_system/">role_system</a>
</li>
            
<li >
    <a href="../code_snippets/small_code_snippets/">小片段</a>
</li>
    </ul>
  </li>
                            
  <li class="dropdown-submenu">
    <a href="#">流程</a>
    <ul class="dropdown-menu">
            
<li class="active">
    <a href="./">基础流程</a>
</li>
            
<li >
    <a href="../%E9%80%BB%E8%BE%91%E6%B5%81%E7%A8%8B/">逻辑流程</a>
</li>
            
<li >
    <a href="../%E6%88%98%E6%96%97%E6%B5%81%E7%A8%8B/">战斗流程</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">client <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../client/code_snippets/">code snippets</a>
</li>
                            
<li >
    <a href="../../client/tmp/">tmp</a>
</li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../code_snippets/small_code_snippets/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../%E9%80%BB%E8%BE%91%E6%B5%81%E7%A8%8B/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#_1">基础流程</a></li>
            <li><a href="#_2">进程启动流程</a></li>
            <li><a href="#_3">客户端协议接收流程</a></li>
            <li><a href="#loginserver">登陆loginserver流程（登陆账号，获取所有角色信息）</a></li>
            <li><a href="#loginserver_1">登陆loginserver流程（登陆角色，获取登陆角色相关信息）</a></li>
            <li><a href="#_4">创建角色流程</a></li>
            <li><a href="#gsdbrole">玩家登入GS流程（从DB初始化Role）</a></li>
            <li><a href="#_5">玩家数据保存流程</a></li>
            <li><a href="#_6">关服玩家数据保存流程</a></li>
            <li><a href="#_7">充值流程</a></li>
            <li><a href="#_8">玩家请求跨服流程</a></li>
            <li><a href="#_9">跨服数据传回原服流程</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="_1">基础流程</h1>
<h2 id="_2">进程启动流程</h2>
<ul>
<li>
<p>执行入口函数main</p>
</li>
<li>
<p>实例化一个Game，它是一个IModule管理器的实现</p>
</li>
<li>
<p>把各种IModule模块注册进Game</p>
</li>
<li>
<p>Game调用Run方法</p>
</li>
<li>
<p>Game进入Loop循环</p>
</li>
<li>
<p>依次执行IModule模块的Init，Start，Update方法</p>
</li>
</ul>
<h2 id="_3">客户端协议接收流程</h2>
<ul>
<li>
<p>gateway进程启动后，为玩家开启监听端口：GatewayModule::Start --&gt; GatewayModule::ListenForUser</p>
</li>
<li>
<p>为玩家开启了端口后，gateway向loginserver索取gameworld的ip和端口，然后连接gameworld。即：发WLRegisterGW到loginserver，loginserver回复协议，gateway处理入口：GatewayModule::OnRegisterGS，然后向gameworld发起连接（InternalComm::NetConnect）</p>
</li>
<li>
<p>开启监听，并成功连接gameworld后，就可以获得如此通讯路径：client --&gt; gateway --&gt; gameworld</p>
</li>
<li>
<p>此后，客户端连接gateway，并给gateway发送协议。gateway处理入口：ServerNetworkCallback::OnRecv --&gt; GatewayModule::OnRecvUserMsg</p>
</li>
<li>
<p>gateway不对协议内容做处理，把协议封装进WGNetRecvMsg，然后转发给gameworld</p>
</li>
<li>
<p>gameworld收到协议，处理入口：World::OnRecv --&gt; World::OnRecvMsg --&gt; SceneManager::OnRecv</p>
</li>
<li>
<p>如果此时玩家没有在gameworld里创建角色（未登录gs），即没有注册进m_net_to_rolelocal，那么执行：MessageHandler::HandleMessageNoLogin --&gt; MessageHandler::OnReqEnter，之后就是<strong>玩家登入GS流程</strong></p>
</li>
<li>
<p>如果玩家已经在gameworld中创建了角色（已登入gs），即已经注册进m_net_to_rolelocal，那么拿到Role所在场景和Role：MessageHandler::GetRoleHelper</p>
</li>
<li>
<p><strong>转进：MessageHandler::HandleMessage</strong></p>
</li>
<li>
<p>解包协议号，从协议处理函数列表（m_msg_handler_list）里拿到已经注册好的处理函数，调用之</p>
</li>
</ul>
<h2 id="loginserver">登陆loginserver流程（登陆账号，获取所有角色信息）</h2>
<ul>
<li>
<p>客户端在服务器列表中选择了服务器后，确认登陆，发送CSLogin协议</p>
</li>
<li>
<p>loginserver进入：LoginServer::OnLoginReq</p>
</li>
<li>
<p>解析协议后，转进：MergeLoginManager::OnLoginReq --&gt; MergeLoginManager::PlatLoginReq</p>
</li>
<li>
<p>需要查询数据库中的角色uid，准备发送RMI请求，创建RMI返回对象：RMIUserLoginBackObjectImpl</p>
</li>
<li>
<p>异步发送RMI请求：RMILoginClient::UserLoginAsyn</p>
</li>
<li>
<p>dataccess进入：<code>RMILoginObject::__UserLogin</code> --&gt; RMILoginObject::UserLogin</p>
</li>
<li>
<p>返回RMI请求，loginserver进入：RMIUserLoginBackObjectImpl::UserLoginRet</p>
</li>
<li>
<p>需要查询数据库中角色的详细信息（RoleInfoList），准备发送RMI请求，创建RMI返回对象：RMIGetRoleInfoBackObjectImpl</p>
</li>
<li>
<p>异步发送RMI请求：RMILRoleClient::GetRoleInfoAsyn</p>
</li>
<li>
<p>dataaccess进入：<code>RMIRoleObject::__GetRoleInfo</code> --&gt; RMIRoleObject::GetRoleInfo</p>
</li>
<li>
<p>返回RMI请求，loginserver进入RMIGetRoleInfoBackObjectImpl::GetRoleInfoRet</p>
</li>
<li>
<p>转进：MergeLoginManager::AddRoleInfoList</p>
</li>
<li>
<p>把玩家信息发送给客户端，即发送协议SCRoleList或SCMergeRoleList</p>
</li>
</ul>
<p><strong>流程图详细版本</strong></p>
<p><img alt="" src="../pic/登录loginserer流程（登陆账号，获取所有角色信息）.png" /></p>
<h2 id="loginserver_1">登陆loginserver流程（登陆角色，获取登陆角色相关信息）</h2>
<ul>
<li>
<p>客户端发送协议CSRoleReq</p>
</li>
<li>
<p>loginserver进入：LoginServer::OnRoleReq</p>
</li>
<li>
<p>需要先验证账号，创建RMI返回对象：RMIUserLoginBackObjectImplRole</p>
</li>
<li>
<p>发送RMI请求：RMILoginClient::UserLoginAsyn</p>
</li>
<li>
<p>dataaccess处理函数：<code>RMILoginObject::__UserLogin</code> --&gt; RMILoginObject::UserLogin</p>
</li>
<li>
<p>返回至loginserver：RMIUserLoginBackObjectImplRole::UserLoginRet</p>
</li>
<li>
<p>再查询要登陆的角色信息，创建RMI返回对象：RMIGetRoleInfoBackObjectImplRoleReq</p>
</li>
<li>
<p>发送RMI请求：RMILRoleClient::GetRoleInfoAsyn</p>
</li>
<li>
<p>dataaccess处理函数：<code>RMIRoleObject::__GetRoleInfo</code> --&gt; RMIRoleObject::GetRoleInfo</p>
</li>
<li>
<p>loginserver返回至：RMIGetRoleInfoBackObjectImplRoleReq::GetRoleInfoRet</p>
</li>
<li>
<p>把查询到的登陆角色信息发给客户端，发送协议：SCLoginAck</p>
</li>
</ul>
<h2 id="_4">创建角色流程</h2>
<ul>
<li>
<p>客户端发送创建角色请求协议：CSCreateRole，包含了玩家的创角信息</p>
</li>
<li>
<p>服务端处理函数入口：LoginServer::OnCreateRole</p>
</li>
<li>
<p>开始向dataaccess发送创角请求，首先验证login表里已经存在的角色uid</p>
</li>
<li>
<p>创建RMI返回对象：RMIUserLoginBackObjectImplCreate，里面保存玩家的创角信息</p>
</li>
<li>
<p>发送RMI请求：RMILoginClient::UserLoginAsyn</p>
</li>
<li>
<p>dataaccess处理函数入口：<code>RMILoginObject::__UserLogin</code> --&gt; RMILoginObject::UserLogin</p>
</li>
<li>
<p>RMI返回loginserver进程，进入：RMIUserLoginBackObjectImplCreate::UserLoginRet</p>
</li>
<li>
<p>需要验证姓名是否重复（role_name_map表），创建RMI返回对象：RMIAddNameInfoBackObjectImpl</p>
</li>
<li>
<p>发送RMI请求：RMILoginClient::AddNameInfoAsyn，dataaccess处理函数入口：<code>RMILoginObject::__AddNameInfo</code> --&gt; RMILoginObject::AddName</p>
</li>
<li>
<p>RMI返回loginserver进程，进入：RMIAddNameInfoBackObjectImpl::AddNameInfoRet</p>
</li>
<li>
<p>开始创建角色，初始化角色信息数据（RoleInitParam），创建RMI返回对象：RMICreateRoleBackObjectImpl</p>
</li>
<li>
<p>发送RMI请求：RMILRoleClient::CreateRoleAsyn，dataaccess处理函数入口：
  <code>RMIRoleObject::__CreateRole</code> --&gt; RMIRoleObject::CreateRole</p>
</li>
<li>
<p>把新角色信息存入Role相关的数据表</p>
</li>
<li>
<p>RMI返回loginserver进程，进入RMICreateRoleBackObjectImpl::CreateRoleRet</p>
</li>
<li>
<p>需要把uid存入login表，创建RMI返回对象：RMIAddRoleBackObjectImpl，发送RMI请求：RMILoginClient::AddRoleAsyn</p>
</li>
<li>
<p>dataaccess处理函数入口：<code>RMILoginObject::__AddRole</code> --&gt; RMILoginObject::AddRole</p>
</li>
<li>
<p>把玩家uid写入login表</p>
</li>
<li>
<p>RMI返回loginserver进程，进入RMIAddRoleBackObjectImpl::AddRoleRet，给客户端发送创角成功协议：SCCreateRoleAck</p>
</li>
<li>
<p>需要更新role_name_map表，创建RMI返回对象：RMIUpdateNameInfoBackObjectImpl，发送RMI请求：RMILoginClient::UpdateNameInfoAsyn，dataaccess处理函数入口：<code>RMILoginObject::__UpdateNameInfo</code> --&gt; RMILoginObject::UpdateNameInfo，RMI返回loginserver，进入：RMIUpdateNameInfoBackObjectImpl::UpdateNameInfoRet，什么都不需要处理</p>
</li>
</ul>
<p>问题：玩家的uid是如何生成的？</p>
<ul>
<li>
<p>创建角色时调用：RMIRoleObject::CreateRoleId</p>
</li>
<li>
<p>从表role_id_map中，插入一行新的纪录，并得到其索引idrole_id_map的值，拿这个值和db_index合为role_id，见RMIRoleObject::CreateRole</p>
</li>
</ul>
<h2 id="gsdbrole">玩家登入GS流程（从DB初始化Role）</h2>
<ul>
<li>
<p>客户端发送请求协议：CSUserEnterGSReq</p>
</li>
<li>
<p>服务端处理入口：MessageHandler::OnReqEnter</p>
</li>
<li>
<p>获取场景信息，需要初始化Role，进入：Scene::RoleEnterSceneAsyn</p>
</li>
<li>
<p>创建RMI返回对象RMIRoleInitBackObjectImpl，然后发送RMI请求：RMIRoleClient::RoleInitAsyn</p>
</li>
<li>
<p>dataaccess处理函数：<code>RMIRoleObject::__RoleInit</code> -&gt; RMIRoleObject::RoleInit</p>
</li>
<li>
<p>拿到玩家数据并序列化传回gs，进入RMIRoleInitBackObjectImpl::RoleInitRet</p>
</li>
<li>
<p>玩家数据反序列化后，进入Scene::RoleEnterScene，开始创建Role</p>
</li>
<li>
<p>初始化Role：Role::Init，把Role加入场景：Scene::AddObj</p>
</li>
<li>
<p>触发Role的进入场景事件：Role::OnEnterScene</p>
</li>
<li>
<p>发给客户端进入场景协议：SCEnterScene</p>
</li>
<li>
<p>执行：Role::OnLogin</p>
</li>
</ul>
<h2 id="_5">玩家数据保存流程</h2>
<p><strong>第一种情况：</strong></p>
<ul>
<li>
<p>当玩家登出或到了保存时间等情况时，调用：Role::Save</p>
</li>
<li>
<p>拿到所有与玩家相关的数据块（各种Param）</p>
</li>
<li>
<p>需要向dataaccess请求存储数据</p>
</li>
<li>
<p>创建RMI返回对象：RMIRoleSaveBackObjectImplRole</p>
</li>
<li>
<p>请求dataaccess：RMIRoleClient::RoleSaveAsyn，把数据块序列化，Call之</p>
</li>
<li>
<p>dataaccess处理函数入口：<code>RMIRoleObject::__RoleSave</code>，把数据块都反序列化</p>
</li>
<li>
<p>开始存入数据库：RMIRoleObject::RoleSave，若是跨服，只保存到缓存中，不存数据库：CrossRoleCacheManager::RoleSave</p>
</li>
<li>
<p>RMI返回，不需要做什么别的处理</p>
</li>
</ul>
<p><strong>第二种情况</strong></p>
<ul>
<li>
<p>当玩家切场景时，也要保存（因为会销毁Role，从而清理DirtyMark）：SceneManager::ChangeLocalSceneHelper</p>
</li>
<li>
<p>创建RMI返回对象：RMIRoleSaveBackObjImplLocal</p>
</li>
<li>
<p>发送RMI请求：SceneManager::SaveRole --&gt; RMIRoleClient::RoleSaveAsyn</p>
</li>
<li>
<p>dataaccess处理函数入口：<code>RMIRoleObject::__RoleSave</code>，把数据块都反序列化</p>
</li>
<li>
<p>开始存入数据库：RMIRoleObject::RoleSave，若是跨服，只保存到缓存中，不存数据库：CrossRoleCacheManager::RoleSave</p>
</li>
<li>
<p>RMI返回，不需要做什么别的处理</p>
</li>
</ul>
<h2 id="_6">关服玩家数据保存流程</h2>
<ul>
<li>
<p>首先关闭gateway</p>
</li>
<li>
<p>gameworld收到gateway断开的信息，见：World::OnDisconnect --&gt; SceneManager::OnGateWayDisconnect</p>
</li>
<li>
<p>需要把所有的玩家都登出：SceneManager::LogoutAllRole -&gt; SceneManager::Logout</p>
</li>
<li>
<p>执行保存操作：Role::Save，接下来走的是玩家数据保存流程</p>
</li>
</ul>
<p>为了等待数据保存完毕才关掉其它进程，在关闭gateway后会sleep若干秒，这是一种简单的策略，但看上去不是很保险，不过测试的时候这样用没问题。</p>
<h2 id="_7">充值流程</h2>
<ul>
<li>
<p>Role::Update</p>
</li>
<li>
<p>每隔一段时间（5分钟），从DB中查询一下元宝信息：Money::GetAccountGoldFromDB</p>
</li>
<li>
<p>创建RMIBackObject：RMIGetGoldBackObjectImpl，发送RMI请求：RMILoginClient::GetGoldAsyn</p>
</li>
<li>
<p>dataaccess处理函数：<code>RMILoginObject::__GetGold</code> --&gt; RMILoginObject::GetGold，从accountgold表中提取出账号（plat_user_name）中的元宝数</p>
</li>
<li>
<p>rmi返回gameworld：RMIGetGoldBackObjectImpl::GetGoldRet，如果账号中的元宝大于0，那么调用Money::GetAccountGoldToRole</p>
</li>
<li>
<p>此时需要对账号中的元宝进行消耗，创建RMIBackObject: RMIChangeGoldBackObjectImpl，发送RMI请求：RMILoginClient::ChangeGoldAsyn</p>
</li>
<li>
<p>dataaccess处理函数：<code>RMILoginObject::__ChangeGold</code> --&gt; RMILoginObject::ChangeGold，更新accountgold表中账号记录，把元宝减掉</p>
</li>
<li>
<p>rmi返回gameworld：RMIChangeGoldBackObjectImpl::ChangeGoldRet，如果此时玩家在线，那么调用：Money::AddGold</p>
</li>
<li>
<p>增加元宝成功，触发充值事件：EventHandler::OnAddChongzhi</p>
</li>
<li>
<p>如果玩家不在线或者Money::AddGold失败，那么需要把元宝加回账号表里</p>
</li>
<li>
<p>创建RMIBackObject: RMIChangeGoldBackObjectImplErrorAdd，发送RMI请求：RMILoginClient::ChangeGoldAsyn，dataaccess调用：<code>RMILoginObject::__ChangeGold</code></p>
</li>
<li>
<p>把钱加回accountgold表中，RMI返回不做其它事情了</p>
</li>
</ul>
<p>可以使用sql语句，模拟外服充值：</p>
<pre><code>INSERT INTO accountgold(plat_user_name) VALUES('ldw_22');
UPDATE accountgold SET gold = '1000' WHERE plat_user_name = 'ldw_22';
</code></pre>

<p>其中ldw_22是平台名，即 账号名+服 的组合，充值完后，5分钟内就能到账了（外服充值完后会马上通知）。</p>
<h2 id="_8">玩家请求跨服流程</h2>
<ul>
<li>
<p>客户端发送请求协议（CSCrossStartReq），请求开始跨服</p>
</li>
<li>
<p>服务端处理函数：MessageHandler::OnCrossStartReq -&gt; RoleCross::OnStartCrossReq</p>
</li>
<li>
<p>做一些可否跨服的检查</p>
</li>
<li>
<p>拿到玩家的一些数据，准备传给跨服：Role::GetCrossRoleParam</p>
</li>
<li>
<p>告诉crossserver有玩家想进入跨服，发送协议GameCrossStartCrossReq</p>
</li>
<li>
<p>crossserver处理函数：CrossServer::OnStartCrossReq</p>
</li>
<li>
<p>检查玩家能否跨服CrossActivityManager::CheckCanStartCross</p>
</li>
<li>
<p>从协议中提取玩家数据，这里会修正一些东西：玩家名（加原服后缀），场景ID（从cross_common.xml中获取）</p>
</li>
<li>
<p>把玩家数据打包进协议CrossGameSaveCrossRoleInfo，发给Hidden GS，做存储用</p>
</li>
<li>
<p>hidden gs处理函数：SceneManager::OnSaveCrossRoleInfo -&gt; CrossUserRegister::OnSaveCrossRoleInfo</p>
</li>
<li>
<p>需要创建跨服中的角色，创建RMI返回对象，RMIGCreateCrossRoleBackObjectImpl</p>
</li>
<li>
<p>发送RMI请求，RMIGRoleClient::CreateCrossRoleAsyn</p>
</li>
<li>
<p>dataaccess处理函数：<code>RMIRoleObject::__CreateCrossRole</code> -&gt; RMIRoleObject::CreateCrossRole -&gt; CrossRoleCacheManager::CreateCrossRole</p>
</li>
<li>
<p>返回到hidden gs：RMIGCreateCrossRoleBackObjectImpl::CreateCrossRoleRet</p>
</li>
<li>
<p>需要保持跨服中的角色，创建RMI返回对象，RMIGRoleSaveBackObjectImplCrossRole</p>
</li>
<li>
<p>发送RMI请求，RMIGRoleClient::RoleSaveAsyn</p>
</li>
<li>
<p>dataaccess处理函数：<code>RMIRoleObject::__RoleSave</code> -&gt; RMIRoleObject::RoleSave -&gt; CrossRoleCacheManager::RoleSave</p>
</li>
<li>
<p>返回到hidden gs: RMIGRoleSaveBackObjectImplCrossRole::RoleSaveRet</p>
</li>
<li>
<p>需要告诉crossserver跨服角色的创建和保存结果，以及跨服的loginserver地址，发送协议GameCrossSaveCrossRoleRet</p>
</li>
<li>
<p>crossserver处理函数：CrossServer::OnSaveCrossRoleRet</p>
</li>
<li>
<p>crossserver转发协议CrossGameStartCrossAck给原服gs，让其通知玩家可以跨服</p>
</li>
<li>
<p>原服gs处理函数：SceneManager::OnStartCrossAck -&gt; RoleCross::OnStartCrossAck</p>
</li>
<li>
<p>告诉玩家loginserver地址等跨服信息，发送协议SCCrossEnterServer</p>
</li>
<li>
<p>之后玩家走的是登陆跨服的loginserver流程</p>
</li>
</ul>
<h2 id="_9">跨服数据传回原服流程</h2>
<blockquote>
<p>这个流程是G18专有的</p>
</blockquote>
<ul>
<li>
<p>在跨服中，Role::Save</p>
</li>
<li>
<p>初始化 RoleSaveCrossParam</p>
</li>
<li>
<p>发送协议给原服：CrossGameSyncRoleData</p>
</li>
<li>
<p>原服收到协议：SceneManager::OnCrossGameSyncRoleData</p>
</li>
<li>
<p>创建RMIBackObj：RMIRoleSaveByCrossBackObjectImpl</p>
</li>
<li>
<p>执行RMI请求：RMIRoleClient::RoleSaveByCrossAsyn</p>
</li>
<li>
<p>把跨服传来的数据，序列化，传给dataaccess</p>
</li>
<li>
<p>dataaccess收到：<code>RMIRoleObject::__RoleSaveByCross</code></p>
</li>
<li>
<p>dataaccess反序列化数据后，存储：RMIRoleObject::RoleSaveByCross</p>
</li>
<li>
<p>RMI返回：RMIRoleSaveByCrossBackObjectImpl相关方法</p>
</li>
<li>
<p>看情况清影子（当玩家登出跨服时），RMIRoleSaveByCrossBackObject::__free</p>
</li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script src="../../js/base.js"></script>
        <script src="../../search/require.js"></script>
        <script src="../../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
